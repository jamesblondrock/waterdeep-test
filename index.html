<!doctype html>
<html lang="es" data-theme="night">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cr√≥nicas de Waterdeep ‚Äî Test de Aptitud</title>

  <!-- Tipograf√≠as estilo compendio (gratis) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=IM+Fell+English:ital@0;1&family=Alegreya:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-night-1:#0b0d11;
      --bg-night-2:#121521;
      --bg-night-3:#0b0d11;

      --ink:#1f1a12;                /* tinta */
      --paper:#f2e6cf;              /* pergamino */
      --paper2:#e8d8b8;             /* sombra pergamino */

      --muted:#5b4a34;              /* sepia */
      --text:#1f1a12;

      --accent:#7b1f1f;             /* rojo lacre */
      --accent2:#2f6b4f;            /* verde sello */
      --danger:#8b1e1e;

      --border:rgba(31,26,18,.18);
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius:18px;

      --font-title: "Cinzel", serif;
      --font-body: "Alegreya", serif;
      --font-flair: "IM Fell English", serif;

      /* ‚úÖ Header colors (por tema) */
      --headerTitle: #f4e9d4;
      --headerSub: rgba(244,233,212,.88);
      --headerSigil: rgba(244,233,212,.80);
      --headerShadow: 0 2px 10px rgba(0,0,0,.45);
    }

    /* Tema ‚ÄúPergamino‚Äù (claro / d√≠a) */
    :root[data-theme="parchment"]{
      --bg-night-1:#f7f1e3;
      --bg-night-2:#f3ead6;
      --bg-night-3:#efe2c7;
      --shadow: 0 10px 24px rgba(10,20,40,.12);

      /* ‚úÖ Header legible en claro */
      --headerTitle: rgba(31,26,18,.92);
      --headerSub: rgba(31,26,18,.70);
      --headerSigil: rgba(31,26,18,.55);
      --headerShadow: none;
    }

    /* Tema ‚ÄúNoche‚Äù (oscuro / tinta) */
    :root[data-theme="night"]{
      --bg-night-1:#0b0d11;
      --bg-night-2:#121521;
      --bg-night-3:#0b0d11;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      /* header usa los defaults de :root */
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family: var(--font-body);
      color: var(--text);
      line-height:1.35;
      background:
        radial-gradient(1100px 600px at 10% 5%, rgba(123,31,31,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(47,107,79,.12), transparent 60%),
        linear-gradient(180deg, var(--bg-night-1) 0%, var(--bg-night-2) 45%, var(--bg-night-3) 100%);
    }

    header{
      padding:28px 16px 10px;
      max-width:980px;
      margin:0 auto;
    }

    /* ‚úÖ Header usa variables por tema */
    h1{
      margin:0 0 8px;
      font-size: clamp(20px, 2.8vw, 30px);
      font-family: var(--font-title);
      letter-spacing:.5px;
      color: var(--headerTitle);
      text-shadow: var(--headerShadow);
    }

    .subtitle{
      margin:0;
      font-size:14px;
      font-family: var(--font-flair);
      color: var(--headerSub);
    }

    .sigil{
      margin: 10px 0 0;
      font-family: var(--font-flair);
      color: var(--headerSigil);
      letter-spacing: .6px;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    /* Panel principal como pergamino */
    .card{
      background:
        radial-gradient(1200px 380px at 30% 0%, rgba(255,255,255,.35), transparent 55%),
        linear-gradient(180deg, var(--paper) 0%, var(--paper2) 100%);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-inner{ padding:16px; }

    .row{
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center;
    }

    label{
      display:block;
      font-size:12px;
      color: rgba(31,26,18,.72);
      margin-bottom:6px;
    }

    input[type="text"]{
      width:min(380px, 100%);
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(31,26,18,.22);
      background: rgba(255,255,255,.35);
      color: var(--ink);
      outline:none;
      font-family: var(--font-body);
    }

    input[type="text"]:focus{
      border-color: rgba(123,31,31,.40);
      box-shadow: 0 0 0 3px rgba(123,31,31,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(31,26,18,.18);
      color: rgba(31,26,18,.72);
      font-size:12px;
      background: rgba(31,26,18,.06);
    }

    .btn{
      appearance:none;
      border:1px solid rgba(123,31,31,.25);
      background: rgba(123,31,31,.10);
      color: var(--ink);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:700;
      font-family: var(--font-title);
      letter-spacing:.3px;
    }

    .btn:hover{ border-color: rgba(123,31,31,.45); }

    .btn.secondary{
      background: rgba(31,26,18,.06);
      border-color: rgba(31,26,18,.18);
    }

    .btn.danger{
      background: rgba(139,30,30,.10);
      border-color: rgba(139,30,30,.25);
    }

    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .progress{
      height:10px;
      background: rgba(31,26,18,.08);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(31,26,18,.18);
      flex:1;
      min-width:200px;
    }

    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(123,31,31,.85), rgba(47,107,79,.75));
      border-radius:999px;
      transition: width .25s ease;
    }

    /* Cabecera de escena como ‚Äúplaca‚Äù */
    .q-head{
      padding:14px 16px;
      border-bottom:1px solid rgba(31,26,18,.20);
      background:
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.06)),
        repeating-linear-gradient(90deg, rgba(0,0,0,.03) 0 14px, rgba(255,255,255,.00) 14px 28px);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }

    .q-title{
      font-weight:700;
      letter-spacing:.4px;
      font-family: var(--font-title);
    }

    .q-meta{
      color: rgba(31,26,18,.72);
      font-size:12px;
    }

    .q-body{ padding:16px; }

    .context{
      color: rgba(31,26,18,.72);
      font-size:12px;
      margin-bottom:10px;
      font-family: var(--font-flair);
    }

    .rule{
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(31,26,18,.35), transparent);
      margin: 8px 0 12px;
    }

    .prompt{
      margin:0 0 14px;
      font-size:15px;
    }

    .prompt::first-letter{
      font-family: var(--font-title);
      font-size: 34px;
      line-height: 1;
      float: left;
      margin: 2px 10px 0 0;
      color: rgba(123,31,31,.85);
    }

    .options{
      display:grid;
      gap:10px;
    }

    .opt{
      border:1px solid rgba(31,26,18,.22);
      border-radius: 14px;
      padding:12px;
      background: rgba(255,255,255,.28);
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }

    .opt:hover{ border-color: rgba(31,26,18,.35); }
    .opt:active{ transform: scale(.995); }

    .opt .letter{
      width:28px; height:28px;
      border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(123,31,31,.10);
      border:1px solid rgba(123,31,31,.25);
      font-weight:800;
      flex:0 0 auto;
      font-family: var(--font-title);
      color: var(--ink);
    }

    .opt.selected{
      border-color: rgba(47,107,79,.35);
      background: rgba(47,107,79,.10);
    }

    .opt .text{
      font-size:13px;
      color: var(--ink);
    }

    .nav{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      padding:14px 16px;
      border-top:1px solid rgba(31,26,18,.18);
      background: rgba(31,26,18,.05);
    }

    .small{
      font-size:12px;
      color: rgba(31,26,18,.72);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    @media (min-width: 900px){
      .grid2{ grid-template-columns: 1.2fr .8fr; }
    }

    .score-table{
      width:100%;
      border-collapse: collapse;
      font-size:13px;
    }

    .score-table th, .score-table td{
      border-bottom:1px solid rgba(31,26,18,.18);
      padding:10px 8px;
      text-align:left;
    }

    .score-table th{
      color: rgba(31,26,18,.72);
      font-weight:700;
      font-size:12px;
      font-family: var(--font-title);
      letter-spacing:.2px;
    }

    .bar{
      height:10px;
      border-radius:999px;
      background: rgba(31,26,18,.08);
      border:1px solid rgba(31,26,18,.18);
      overflow:hidden;
    }

    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(123,31,31,.85), rgba(47,107,79,.75));
    }

    .notice{
      color: rgba(31,26,18,.72);
      font-size:12px;
      margin-top:8px;
      font-family: var(--font-flair);
    }

    .error{
      color: #5a1a1a;
      background: rgba(139,30,30,.10);
      border: 1px solid rgba(139,30,30,.22);
      padding:10px 12px;
      border-radius: 14px;
      font-family: var(--font-body);
    }

    .ok{
      color: #12452f;
      background: rgba(47,107,79,.10);
      border: 1px solid rgba(47,107,79,.22);
      padding:10px 12px;
      border-radius: 14px;
      font-family: var(--font-body);
    }

    /* Radar como l√°mina */
    #radar{
      width:100%;
      max-width:650px;
      background:
        radial-gradient(800px 320px at 30% 0%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(180deg, rgba(242,230,207,.95), rgba(232,216,184,.95));
      border: 1px solid rgba(31,26,18,.18) !important;
      border-radius:16px;
    }
  </style>
</head>

<body>
<header>
  <h1>üé≤ Cr√≥nicas de Waterdeep ‚Äî Test de Aptitud</h1>
  <p class="subtitle">
    Lee cada situaci√≥n cuidadosamente. No elijas lo que crees que es ‚Äúcorrecto‚Äù; elige lo que tu personaje har√≠a en el calor del momento.
    Piensa que tu personaje es capaz de ejecutar cualquier respuesta planteada.
  </p>
  <p class="sigil">‚Äî Registro de Aventureros ¬∑ Waterdeep ‚Äî</p>
</header>

<div class="wrap">
  <div class="card">
    <div class="card-inner">
      <div class="row">
        <div>
          <label for="playerName">Nombre/alias del jugador</label>
          <input id="playerName" type="text" placeholder="Ej: V√≠ctor / Manuel / David..." />
        </div>
        <div>
          <label for="characterName">Nombre del personaje</label>
          <input id="characterName" type="text" placeholder="Ej: Ecco / Theorc / Jul...'" />
        </div>
        <div class="pill" id="autosavePill">üíæ Autoguardado: activo</div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="progress" aria-label="Progreso"><div id="progressBar"></div></div>
        <div class="pill"><span id="progressText">0/20</span></div>

        <button class="btn secondary" id="themeBtn" type="button">üåô Noche</button>
        <button class="btn secondary" id="toggleResultsBtn" type="button">üëÅÔ∏è Mostrar resultado al final: S√≠</button>
        <button class="btn danger" id="resetBtn" type="button">‚ôªÔ∏è Reiniciar</button>
      </div>

      <p class="notice">Consejo: funciona en m√≥vil. Si cierras la p√°gina, al volver se recupera el progreso (en este dispositivo).</p>
    </div>
  </div>

  <div class="card" id="questionCard">
    <div class="q-head">
      <div>
        <div class="q-title" id="qTitle">Escena</div>
        <div class="q-meta" id="qMeta"></div>
      </div>
      <div class="pill">Escena <span id="qIndexPill">1</span>/20</div>
    </div>

    <div class="q-body">
      <div class="context" id="qContext"></div>
      <div class="rule"></div>
      <p class="prompt" id="qPrompt"></p>
      <div class="options" id="options"></div>
      <div id="msgArea" style="margin-top:12px;"></div>
    </div>

    <div class="nav">
      <button class="btn secondary" id="prevBtn" type="button">‚Üê Anterior</button>
      <div class="small">Puedes saltar escenas, pero no podr√°s enviar hasta completar las 20.</div>
      <button class="btn" id="nextBtn" type="button">Siguiente ‚Üí</button>
    </div>
  </div>

  <div class="card" id="resultCard" style="display:none;">
    <div class="q-head">
      <div class="q-title">Resultado</div>
      <div class="q-meta">Afinidad por facci√≥n</div>
    </div>

    <div class="card-inner grid2">
      <div>
        <canvas id="radar" width="520" height="420"></canvas>
        <p class="notice">Esto es una afinidad aproximada basada en tus elecciones; no te ‚Äúencasilla‚Äù.</p>
      </div>

      <div>
        <table class="score-table" id="scoreTable">
          <thead>
            <tr><th>Facci√≥n</th><th>%</th><th style="width:40%;">&nbsp;</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="row" style="margin-top:12px; justify-content:flex-end;">
          <button class="btn secondary" id="backToReviewBtn" type="button">‚Ü© Revisar respuestas</button>
          <button class="btn" id="submitBtn" type="button">üì® Enviar respuestas</button>
        </div>

        <div id="submitMsg" style="margin-top:12px;"></div>

        <!-- Solo DM -->
        <div id="dmOnly" style="display:none; margin-top:12px;">
          <div class="rule"></div>
          <div class="pill">üïµÔ∏è Solo DM</div>
          <pre id="dmNarrative" class="notice" style="white-space:pre-wrap; margin-top:10px;"></pre>
          <div class="row" style="margin-top:12px; justify-content:flex-end;">
            <button class="btn secondary" id="copyProfileBtn" type="button">üìã Copiar perfil</button>
          </div>
        </div>

        <p class="notice">Al enviar, se mandan: nombre/alias, personaje, respuestas (A‚ÄìD) y puntuaci√≥n calculada.</p>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * CONFIG
 * Pega aqu√≠ tu endpoint de Formspree:
 */
const FORM_ENDPOINT = "https://formspree.io/f/xbdajrjl"; // <-- REEMPLAZA

/**
 * Mostrar resultado al jugador (por defecto):
 */
let SHOW_RESULTS_TO_PLAYER = true;

/**
 * üîê Protecci√≥n de resultados
 * - Jugadores: se pide contrase√±a al mostrar resultados
 * - DM: si entras con ?dm=true, no se pide contrase√±a
 */
const RESULTS_PASSWORD = "waterdeep"; // <-- CAMBIA AQU√ç
const isDM = new URLSearchParams(location.search).get("dm") === "true";


/**
 * Tema: ‚ÄúüïØÔ∏è Pergamino‚Äù / ‚Äúüåô Noche‚Äù
 */
const THEME_KEY = "wd_theme";

/**
 * Facciones y etiquetas (8)
 */
const FACTIONS = [
  { code:"HAR", name:"Harpers (Los Arpistas)" },
  { code:"OOG", name:"Order of the Gauntlet (Orden del Guantelete)" },
  { code:"EE",  name:"Emerald Enclave (Enclave Esmeralda)" },
  { code:"LA",  name:"Lords' Alliance (Alianza de los Se√±ores)" },
  { code:"ZH",  name:"Zhentarim (La Red Negra)" },
  { code:"BD",  name:"Bregan D'aerthe" },
  { code:"GH",  name:"Gray Hands (Manos Grises)" },
  { code:"XG",  name:"Xanathar Guild (Gremio de Xanathar)" },
];

/**
 * MATRIZ DE SCORING: escena+opci√≥n -> {primary, secondary}
 * Regla: +2 primary, +1 secondary
 */
const SCORE_KEY = {
  "1-A": {p:"LA", s:"GH"}, "1-B": {p:"BD", s:"ZH"}, "1-C": {p:"XG", s:"ZH"}, "1-D": {p:"OOG", s:"HAR"},
  "2-A": {p:"GH", s:"LA"}, "2-B": {p:"OOG", s:"EE"}, "2-C": {p:"ZH", s:"BD"}, "2-D": {p:"ZH", s:"XG"},
  "3-A": {p:"OOG", s:"GH"}, "3-B": {p:"GH", s:"LA"}, "3-C": {p:"XG", s:"ZH"}, "3-D": {p:"BD", s:"HAR"},
  "4-A": {p:"BD", s:"ZH"}, "4-B": {p:"LA", s:"OOG"}, "4-C": {p:"HAR", s:"GH"}, "4-D": {p:"XG", s:"ZH"},
  "5-A": {p:"OOG", s:"LA"}, "5-B": {p:"XG", s:"ZH"}, "5-C": {p:"HAR", s:"BD"}, "5-D": {p:"GH", s:"LA"},
  "6-A": {p:"LA", s:"ZH"}, "6-B": {p:"EE", s:"HAR"}, "6-C": {p:"EE", s:"LA"}, "6-D": {p:"XG", s:"ZH"},
  "7-A": {p:"LA", s:"OOG"}, "7-B": {p:"HAR", s:"OOG"}, "7-C": {p:"LA", s:"HAR"}, "7-D": {p:"ZH", s:"XG"},
  "8-A": {p:"LA", s:"HAR"}, "8-B": {p:"HAR", s:"BD"}, "8-C": {p:"BD", s:"LA"}, "8-D": {p:"GH", s:"HAR"},
  "9-A": {p:"LA", s:"GH"}, "9-B": {p:"ZH", s:"HAR"}, "9-C": {p:"BD", s:"ZH"}, "9-D": {p:"HAR", s:"BD"},
  "10-A":{p:"LA", s:"GH"}, "10-B":{p:"HAR", s:"GH"}, "10-C":{p:"ZH", s:"BD"}, "10-D":{p:"BD", s:"XG"},
  "11-A":{p:"GH", s:"LA"}, "11-B": {p:"ZH", s:"BD"}, "11-C":{p:"HAR", s:"LA"}, "11-D":{p:"ZH", s:"BD"},
  "12-A":{p:"LA", s:"GH"}, "12-B": {p:"LA", s:"HAR"}, "12-C":{p:"HAR", s:"BD"}, "12-D":{p:"ZH", s:"XG"},
  "13-A":{p:"OOG", s:"LA"}, "13-B": {p:"HAR", s:"BD"}, "13-C":{p:"GH", s:"LA"}, "13-D":{p:"BD", s:"HAR"},
  "14-A":{p:"LA", s:"HAR"}, "14-B": {p:"GH", s:"LA"}, "14-C":{p:"HAR", s:"BD"}, "14-D":{p:"HAR", s:"GH"},
  "15-A":{p:"LA", s:"OOG"}, "15-B": {p:"HAR", s:"OOG"}, "15-C":{p:"BD", s:"ZH"}, "15-D":{p:"HAR", s:"LA"},
  "16-A":{p:"LA", s:"GH"}, "16-B": {p:"HAR", s:"GH"}, "16-C":{p:"ZH", s:"BD"}, "16-D":{p:"GH", s:"ZH"},
  "17-A":{p:"LA", s:"GH"}, "17-B": {p:"HAR", s:"BD"}, "17-C":{p:"GH", s:"LA"}, "17-D":{p:"ZH", s:"XG"},
  "18-A":{p:"HAR", s:"LA"}, "18-B": {p:"HAR", s:"BD"}, "18-C":{p:"BD", s:"ZH"}, "18-D":{p:"XG", s:"BD"},
  "19-A":{p:"LA", s:"OOG"}, "19-B": {p:"HAR", s:"LA"}, "19-C":{p:"OOG", s:"LA"}, "19-D":{p:"HAR", s:"BD"},
  "20-A":{p:"LA", s:"GH"}, "20-B": {p:"HAR", s:"BD"}, "20-C":{p:"BD", s:"ZH"}, "20-D":{p:"GH", s:"LA"},
};

/**
 * PREGUNTAS (20 escenas)
 */
const QUESTIONS = [
  {
    title:"ESCENA 1: La diplomacia de la daga",
    context:"(Distrito de los Palacios ¬∑ Anochecer)",
    prompt:"Has descubierto que un Lord Enmascarado de Waterdeep est√° siendo chantajeado por una potencia extranjera. Tienes pruebas, pero exponerlo podr√≠a desestabilizar la econom√≠a de la ciudad. Decides escribirle una carta antes de actuar. ¬øQu√© tono y contenido tiene esa carta?",
    options:{
      A:"Una misiva formal, sellada con lacre, citando el C√≥digo Legal de Waterdeep. Le ofreces un plazo de 24 horas para entregarse a la Guardia de la Ciudad y mitigar su sentencia, o enfrentar√°s el peso de la ley sobre √©l.",
      B:"Una nota an√≥nima, escrita en clave y dejada en su almohada. Le ofreces ‚Äúsolucionar‚Äù su problema con los extranjeros a cambio de un favor futuro y acceso a sus redes de informaci√≥n. Mejor tener a un Lord en deuda contigo que en la c√°rcel.",
      C:"No hay carta. Irrumpes en su estudio por la noche, pones tu daga en su mesa y le dices: ‚ÄúTu vida me pertenece ahora. O trabajas para mi organizaci√≥n y nos das el 30% de tus ingresos, o ma√±ana todo el mundo sabr√° tu secreto‚Äù.",
      D:"Una carta p√∫blica, clavada en las puertas del Castillo de Waterdeep. La verdad debe salir a la luz, caiga quien caiga."
    }
  },
  {
    title:"ESCENA 2: El artefacto de Bajomonta√±a",
    context:"(Galer√≠a derrumbada ¬∑ Sin testigos)",
    prompt:"En las profundidades de una mazmorra, tu grupo encuentra el ‚ÄúOrbe de la Tormenta Ps√≠quica‚Äù. Es inestable. Incluso envuelto y aislado, notas c√≥mo interfiere con los pensamientos y la magia cercana. Podr√≠a arrasar varias manzanas si falla‚Ä¶ o amplificar el poder arcano de quien lo controle de forma casi inimaginable. No hay testigos. Nadie m√°s sabe que existe. ¬øQu√© haces con √©l?",
    options:{
      A:"Busco un mago disciplinado y leal a la ciudad. Consideras que son los √∫nicos que tienen la autoridad y el conocimiento para contener algo as√≠.",
      B:"Lo destruyo in situ, aunque me cueste un gran esfuerzo o recursos. Nadie, ni siquiera nosotros, deber√≠a tener tal poder. Es una aberraci√≥n contra el orden natural y m√°gico.",
      C:"Me lo quedo en secreto. No lo usar√©... todav√≠a. Pero es una ‚Äúp√≥liza de seguro‚Äù perfecta. Si alguna vez me veo acorralado por enemigos superiores, tendr√© un as bajo la manga.",
      D:"Lo vendo en el mercado negro de Waterdeep. El riesgo es alto, pero el oro que obtendr√≠a me permitir√≠a financiar un ej√©rcito privado o comprar influencias que me dar√°n poder real, no m√°gico."
    }
  },
  {
    title:"ESCENA 3: El disturbio en el Distrito del Puerto",
    context:"(Distrito del Puerto ¬∑ Mediod√≠a)",
    prompt:"Una plaga m√°gica ha vuelto violentos a los trabajadores del puerto. Est√°n destrozando almacenes y atacando a los guardias. No son malvados, est√°n hechizados. La Guardia est√° siendo superada y se prepara para usar fuerza letal. ¬øC√≥mo intervienes?",
    options:{
      A:"Me lanzo al centro del caos usando magia de control y ataques no letales para incapacitar a tantos como pueda, protegiendo a los civiles con mi propio cuerpo si es necesario.",
      B:"Me posiciono en los tejados y elimino a los l√≠deres o a los m√°s violentos con precisi√≥n quir√∫rgica.",
      C:"Aprovecho la confusi√≥n. Mientras todos miran la pelea, saqueo los almacenes de especias y sedas que han quedado desprotegidos.",
      D:"Uso una ilusi√≥n masiva o pirotecnia espectacular (fuegos artificiales, drag√≥n ilusorio) para asustar a la multitud y dispersarlos. Soluciono el problema con estilo, sin derramar sangre y quedando como una leyenda local."
    }
  },
  {
    title:"ESCENA 4: El esp√≠a",
    context:"(S√≥tano alquilado ¬∑ Madrugada)",
    prompt:"Has capturado a un esp√≠a de la banda conocida de Waterdeep. Sabes que tiene informaci√≥n sobre una entrada secreta a la ciudad. √âl te mira con arrogancia y no habla. ¬øCu√°l es tu m√©todo?",
    options:{
      A:"Le ofrezco un trato comercial. ‚ÄúTu jefe valora el beneficio. Si nos das la informaci√≥n, te pagaremos m√°s de lo que √©l te ofrece y te dejaremos ir. Solo son negocios‚Äù.",
      B:"‚ÄúLa ley dice que los esp√≠as son ejecutados‚Äù. Preparo el hacha del verdugo frente a √©l. No estoy jugando; si no hablas en 10 segundos, su cabeza rodar√° como advertencia para otros.",
      C:"Lo dejo ir, pero le coloco un rastreador m√°gico o env√≠o a mi familiar a seguirlo. Me llevar√° a su guarida y podr√© desmantelar toda la c√©lula, no solo obtener un dato.",
      D:"Traigo a la bestia m√°s aterradora que conozca (o invoco un demonio menor) y lo dejo a solas con el prisionero."
    }
  },
  {
    title:"ESCENA 5: La elecci√≥n del aliado",
    context:"(Mesa privada ¬∑ Trato r√°pido)",
    prompt:"Para completar una misi√≥n suicida, necesitas un especialista externo. Tienes cuatro candidatos, pero solo puedes pagar a uno. ¬øA qui√©n contratas?",
    options:{
      A:"A un palad√≠n de Torm, famoso por no mentir jam√°s y proteger a los d√©biles. Puede que sea r√≠gido, pero s√© que nunca me apu√±alar√° por la espalda.",
      B:"A un mat√≥n bugbear. Es brutal, est√∫pido y barato. Si muere, no me importa; y si sobrevive, es una fuerza de choque excelente.",
      C:"A un bardo encantador. No es el mejor en combate, pero puede conseguirnos invitaciones, mapas y rumores que valen m√°s que cien espadas.",
      D:"A un mago de guerra. Necesito potencia de fuego bruta y disciplina. Alguien que siga √≥rdenes y haga explotar cosas cuando yo lo diga."
    }
  },
  {
    title:"ESCENA 6: La bestia del bosque",
    context:"(L√≠mite del bosque ¬∑ Amanecer)",
    prompt:"Un grupo de nobles quiere talar una secci√≥n de un bosque para construir una nueva villa de lujo. Los esp√≠ritus del bosque est√°n matando a los le√±adores en represalia. Los nobles te contratan para ‚Äúsolucionarlo‚Äù. ¬øQu√© haces?",
    options:{
      A:"Cazo a los esp√≠ritus. Un contrato es un contrato, y la civilizaci√≥n necesita expandirse. Adem√°s, la paga de los nobles es excelente.",
      B:"Saboteo la construcci√≥n por la noche, destruyo la maquinaria y asusto a los nobles para que se vayan. El bosque estaba all√≠ antes que nosotros y debe ser respetado.",
      C:"Negocio una tregua. Convenzo a los nobles de construir en otro lado o de hacer un santuario dru√≠dico a cambio de que los esp√≠ritus cesen los ataques. El equilibrio es la clave.",
      D:"Mato a los nobles y culpo a los esp√≠ritus. Esos arist√≥cratas son par√°sitos y el mundo estar√° mejor sin ellos. Adem√°s, puedo quedarme con sus joyas."
    }
  },
  {
    title:"ESCENA 7: El juicio",
    context:"(Tribunal menor ¬∑ D√≠a gris)",
    prompt:"Un joven ladr√≥n ha robado medicinas para su hermana enferma. La ley de Waterdeep es clara: robo es robo y debe ser castigado (posiblemente perdiendo una mano o a√±os de c√°rcel). T√∫ eres el testigo clave. ¬øQu√© declaras?",
    options:{
      A:"‚ÄúLo vi todo. Rob√≥ la medicina‚Äù. La ley es dura, pero es la ley. Si empezamos a hacer excepciones por pena, el sistema legal se derrumba.",
      B:"‚ÄúNo vi nada, se√±or juez‚Äù. Miento descaradamente para protegerlo. A veces la justicia moral est√° por encima de la justicia legal. Luego le doy oro al chico para que huya.",
      C:"Pago la fianza y el costo de la medicina yo mismo, convirtiendo el ‚Äúrobo‚Äù en una ‚Äúcompra tard√≠a‚Äù. Uso mi influencia y dinero para resolver el problema sin romper el sistema ni arruinar al chico.",
      D:"Aprovecho la situaci√≥n. Testifico a su favor, pero luego busco al chico y le digo: ‚ÄúTe salv√© la vida. Ahora me perteneces. Har√°s trabajos para m√≠ hasta que tu deuda est√© saldada‚Äù."
    }
  },
  {
    title:"ESCENA 8: El asiento vac√≠o",
    context:"(Recepci√≥n privada ¬∑ Distrito de los Palacios ¬∑ M√∫sica de c√°mara)",
    prompt:"Est√°s infiltrado en una recepci√≥n reducida, pocas personas, todas importantes. Tu contacto deb√≠a presentarte a alguien clave, pero no ha llegado. Un noble veterano, claramente ebrio, ocupa el asiento reservado para esa persona y empieza a hablar en voz alta de asuntos que no deber√≠a conocer. Varias miradas se dirigen a √©l‚Ä¶ y a ti. Si esto escala, tu presencia aqu√≠ se recordar√°. ¬øQu√© haces?",
    options:{
      A:"Te acercas y reconduces la conversaci√≥n hacia un tema inocuo, d√°ndole una salida elegante sin humillarlo.",
      B:"Aprovechas lo que est√° diciendo y memorizas cada detalle, aunque eso implique quedarte expuesto unos minutos m√°s.",
      C:"Provocas una interrupci√≥n menor (un tropiezo, una discusi√≥n lateral) que obliga a redistribuir a los invitados.",
      D:"Te levantas y abandonas la recepci√≥n antes de que nadie te asocie con la situaci√≥n."
    }
  },
  {
    title:"ESCENA 9: El libro prestado",
    context:"(Archivo secundario ¬∑ Distrito de los Eruditos ¬∑ Tarde)",
    prompt:"Te han dado acceso temporal a una sala de archivo poco usada. Mientras revisas pergaminos menores, encuentras un libro mal catalogado entre tratados inofensivos. No tiene sello, no est√° registrado y al abrirlo reconoces f√≥rmulas que no deber√≠an aparecer en un archivo civil. Antes de que puedas decidir nada, oyes pasos en el pasillo. Alguien va a entrar. ¬øQu√© haces en ese instante?",
    options:{
      A:"Cierras el libro, lo colocas exactamente d√≥nde estaba y te apartas de la estanter√≠a.",
      B:"Arrancas una sola p√°gina, la doblas y la ocultas antes de devolver el libro a su sitio.",
      C:"Te llevas el libro contigo mezcl√°ndolo con otros vol√∫menes autorizados.",
      D:"Dejas el libro abierto sobre la mesa, como si hubiera sido consultado por cualquiera."
    }
  },
  {
    title:"ESCENA 10: El final del d√≠a",
    context:"(Taberna menor ¬∑ Noche cerrada)",
    prompt:"Est√°s descansando en una taberna mirando tu bolsa de oro y tus heridas. ¬øQu√© pensamiento cruza tu mente?",
    options:{
      A:"‚ÄúHa valido la pena. La ciudad es un poco m√°s segura hoy gracias a m√≠.‚Äù",
      B:"‚ÄúEspero que nadie descubra lo que he hecho hoy. Pero alguien ten√≠a que ensuciarse las manos para que los dem√°s duerman tranquilos.‚Äù",
      C:"‚ÄúVaya d√≠a. He ganado una buena suma, he hecho contactos √∫tiles y sigo vivo. Ma√±ana a por m√°s.‚Äù",
      D:"‚Äú¬°Qu√© aventura! El peligro, la emoci√≥n, la adrenalina... No podr√≠a vivir de otra manera.‚Äù"
    }
  },
  {
    title:"ESCENA 11: El encargo",
    context:"(C√°mara privada ¬∑ Sin ventanas)",
    prompt:"Una archimaga te convoca en su torre. Un artefacto robado, ‚Äúun Anillo de Almacenamiento de Conjuros‚Äù cargado con desintegrar, ha aparecido en el mercado negro. Te autoriza a recuperarlo ‚Äúpor cualquier medio‚Äù, pero deja claro que no quiere testigos ni esc√°ndalos.",
    options:{
      A:"Sigo sus √≥rdenes al pie de la letra. Act√∫o r√°pido, limpio y silencioso. Si alguien muere, es el precio de proteger la ciudad.",
      B:"Recupero el anillo, pero dejo pruebas falsas que incriminen a una facci√≥n rival. As√≠ se evita el esc√°ndalo‚Ä¶ y se gana ventaja pol√≠tica.",
      C:"Devuelvo el anillo, pero informo discretamente a otra facci√≥n de que la archimaga autoriz√≥ acciones extralegales. El poder debe vigilarse.",
      D:"Me quedo con el anillo unos d√≠as ‚Äúpor seguridad‚Äù. Tener acceso al conjuro desintegrar puede cambiar muchas conversaciones."
    }
  },
  {
    title:"ESCENA 12: El Inventario Incompleto",
    context:"(Almac√©n portuario ¬∑ Primera hora de la ma√±ana)",
    prompt:"Revisando un almac√©n tras una incautaci√≥n menor, descubres que faltan tres cajas en el inventario oficial. No hay firmas falsas ni sellos rotos: simplemente no est√°n. El encargado te observa con atenci√≥n, esperando a ver qu√© haces. Si informas, se abrir√° una investigaci√≥n larga y ruidosa. Si no lo haces, nadie notar√° la ausencia hasta dentro de semanas. ¬øQu√© haces antes de abandonar el almac√©n?",
    options:{
      A:"Anotas la falta en el registro y entregas el informe tal cual, sin a√±adir comentarios.",
      B:"Hablas en privado con el encargado y le das una oportunidad para ‚Äúcorregir‚Äù el inventario antes del mediod√≠a.",
      C:"No escribes nada en el registro, pero marcas discretamente el suelo del almac√©n donde deber√≠an haber estado las cajas, usando una se√±al que solo t√∫ reconocer√≠as despu√©s.",
      D:"Ajustas el inventario para que cuadre y te llevas uno de los documentos originales."
    }
  },
  {
    title:"ESCENA 13: El hechizo en la Plaza de los Carros",
    context:"(Plaza abarrotada ¬∑ Instantes)",
    prompt:"Una multitud se vuelve hostil tras un rumor de impuestos abusivos. Hay ni√±os, mercaderes y agentes encubiertos mezclados. Tienes un solo conjuro antes de que la situaci√≥n estalle.",
    options:{
      A:"Calmar emociones, buscando desactivar la violencia aunque los cabecillas escapen.",
      B:"Sugesti√≥n sobre el l√≠der visible para que disperse a la gente ‚Äúpor su propio bien‚Äù.",
      C:"Patr√≥n hipn√≥tico, aunque algunos inocentes queden atrapados y vulnerables.",
      D:"Ninguno. Dejas que la revuelta estalle para ver qui√©n se mueve desde las sombras."
    }
  },
  {
    title:"ESCENA 14: El serm√≥n interrumpido",
    context:"(Distrito Norte ¬∑ Tarde lluviosa)",
    prompt:"En una plaza menor del Distrito Norte, un predicador improvisado re√∫ne a curiosos. No invoca dioses, no blasfema, no incita a la violencia. Solo repite una idea inc√≥moda: ‚ÄúLos templos no os protegen. Os protegen los que sangran por vosotros.‚Äù Ves a dos agentes de la Guardia observando sin intervenir. Un sacerdote de un templo cercano te reconoce y se acerca. En voz baja te dice: ‚ÄúSi esto sigue, ma√±ana tendremos problemas‚Äù. ¬øQu√© haces ahora?",
    options:{
      A:"Te acercas al predicador y le haces preguntas p√∫blicas, llev√°ndolo poco a poco a contradicciones hasta que la gente pierde inter√©s.",
      B:"Convences a la Guardia de que disperse la reuni√≥n por ‚Äúobstrucci√≥n del paso‚Äù, sin detener a nadie.",
      C:"Te mezclas con la multitud y memorizas a qui√©nes escuchan con m√°s atenci√≥n. Esto no va del predicador.",
      D:"Esperas a que termine y lo sigues. Quieres saber qui√©n le da de comer y d√≥nde duerme."
    }
  },
  {
    title:"ESCENA 15: El Incidente del basti√≥n",
    context:"(Templo fortificado ¬∑ Madrugada)",
    prompt:"Durante una guardia nocturna en el basti√≥n, una explosi√≥n menor sacude un patio interior. Un ni√±o ac√≥lito ha reaccionado instintivamente a una ca√≠da lanzando escudo. No hay heridos. El prior del templo te mira serio: ‚ÄúEsto no deber√≠a pasar.‚Äù El ni√±o est√° asustado. Nadie m√°s ha visto el conjuro. ¬øQu√© haces antes de que llegue el amanecer?",
    options:{
      A:"Informas al prior y dejas que el templo gestione el asunto seg√∫n sus reglas.",
      B:"Hablas a solas con el ni√±o y le pides que no vuelva a hacerlo hasta que t√∫ regreses.",
      C:"Haces que otro ac√≥lito se lleve la culpa del ruido para cerrar el incidente.",
      D:"Pagas a un escribano independiente para que copie el informe y lo haga circular por los canales administrativos correctos, sin que tu nombre aparezca en ning√∫n lado."
    }
  },
  {
    title:"ESCENA 16: La puerta sellada",
    context:"(Indeterminada ¬∑ Profundidad incierta)",
    prompt:"Encuentras una puerta arcana sellada. Detr√°s hay algo que no deber√≠a estar all√≠, seg√∫n tus conocimientos arcanos.",
    options:{
      A:"La sellas de nuevo y marcas la localizaci√≥n para futuras generaciones.",
      B:"La abres parcialmente para estudiar lo que hay, sin cruzar del todo.",
      C:"La fuerzas. Est√°s convencido de que alberga algo valioso.",
      D:"Rediriges la puerta para que conecte con territorio enemigo."
    }
  },
  {
    title:"ESCENA 17: El prisionero",
    context:"(Almac√©n vac√≠o ¬∑ Marea baja ¬∑ Olor a sal y algas)",
    prompt:"El hombre est√° atado a una columna. No es importante. No lleva insignias, no conoce planes completos, pero reconoces varios nombres cuando habla sin darse cuenta. Desde fuera llega el sonido de cuerdas tens√°ndose: alguien est√° preparando un barco cercano. No tienes mucho tiempo. ¬øQu√© haces antes de que amanezca?",
    options:{
      A:"Lo entregas a la Guardia con un informe m√≠nimo y te marchas antes de que empiecen las preguntas.",
      B:"Haces correr el rumor de que ya ha hablado y lo liberas sin decirle nada m√°s.",
      C:"Lo dejas inconsciente en un punto visible del muelle, con una se√±al clara de advertencia, pero sin explicaci√≥n.",
      D:"Le das una tarea peque√±a y verificable que debe cumplir en las pr√≥ximas horas si quiere seguir respirando."
    }
  },
  {
    title:"ESCENA 18: El S√≠mbolo en el callej√≥n",
    context:"(Distrito del Puerto ¬∑ De noche)",
    prompt:"Tras una operaci√≥n limpia, un callej√≥n queda vac√≠o. No hay cuerpos, no hay testigos, pero alguien va a revisar el lugar antes del amanecer. Tienes tiempo para dejar una sola se√±al. No es obligatoria. Nadie te lo ha pedido.",
    options:{
      A:"No dejas nada. El silencio es m√°s inquietante que cualquier marca.",
      B:"Un s√≠mbolo antiguo, apenas visible, que solo reconocer√° quien sepa exactamente qu√© buscar.",
      C:"Una marca burda y evidente, f√°cil de interpretar, aunque no sea del todo cierta.",
      D:"Dejas un objeto cotidiano colocado de forma deliberada."
    }
  },
  {
    title:"ESCENA 19: La reliquia devuelta",
    context:"(Camino Alto ¬∑ Mediod√≠a)",
    prompt:"Te prestaron una reliquia sagrada para una misi√≥n concreta que te result√≥ muy √∫til. La devuelves tal y como te la dejaron, en un cofre sellado. Antes de entregarla, notas algo: el sello interior ha sido manipulado. No sabes si antes‚Ä¶ o despu√©s de usarla. Nadie m√°s parece haberse dado cuenta. ¬øQu√© haces?",
    options:{
      A:"La entregas tal cual. No es tu funci√≥n cuestionar herramientas que ya han cumplido su prop√≥sito.",
      B:"Cierras el cofre delante del custodio sin mencionar el detalle, pero te aseguras de que vea el estado del sello antes de marcharte.",
      C:"Reparas el sello discretamente antes de entregarla.",
      D:"Retrasas la entrega alegando un motivo menor y observas qui√©n pregunta por la reliquia y con qu√© urgencia."
    }
  },
  {
    title:"ESCENA 20: La cuenta del Portal Bostezante",
    context:"(Cierre / Poder real / Huella invisible)",
    prompt:"Es tarde. El Portal Bostezante est√° medio vac√≠o. Durnan te deja una jarra y una tablilla de cuentas sin decir nada. Alguien ha pagado toda la deuda de la noche: bebidas, habitaciones, da√±os‚Ä¶ todo. No hay nombre. Solo una marca distinta seg√∫n qui√©n haya hecho el pago. Durnan te pregunta una sola cosa: ‚Äú¬øQuieres saber qui√©n ha sido?‚Äù ¬øQu√© haces?",
    options:{
      A:"Dices que no. Te igual qui√©n haya pagado; lo importante es que el problema est√° resuelto. Te bebes la cerveza y te vas.",
      B:"Le pides que deje la tablilla donde est√° y observas qui√©n reacciona cuando Durnan comenta el pago en voz alta.",
      C:"Pides que corra la voz de que t√∫ has saldado la cuenta. No lo desmientes ni lo confirmas.",
      D:"Pagas t√∫ mismo una parte menor de la cuenta y dejas claro que no quieres explicaciones."
    }
  }
];

// ---------- UI state ----------
const playerNameEl = document.getElementById("playerName");
const characterNameEl = document.getElementById("characterName");
const resetBtn = document.getElementById("resetBtn");
const toggleResultsBtn = document.getElementById("toggleResultsBtn");
const themeBtn = document.getElementById("themeBtn");

const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

const qTitle = document.getElementById("qTitle");
const qMeta = document.getElementById("qMeta");
const qContext = document.getElementById("qContext");
const qPrompt = document.getElementById("qPrompt");
const optionsEl = document.getElementById("options");
const qIndexPill = document.getElementById("qIndexPill");
const msgArea = document.getElementById("msgArea");

const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");

const questionCard = document.getElementById("questionCard");
const resultCard = document.getElementById("resultCard");
const backToReviewBtn = document.getElementById("backToReviewBtn");
const submitBtn = document.getElementById("submitBtn");
const submitMsg = document.getElementById("submitMsg");

const scoreTableBody = document.querySelector("#scoreTable tbody");
const radarCanvas = document.getElementById("radar");
const radarCtx = radarCanvas.getContext("2d");

const LS_KEY = "wd_affinity_quiz_v2";

let state = {
  idx: 0,
  playerName: "",
  characterName: "",
  showResults: SHOW_RESULTS_TO_PLAYER,
  answers: Array(20).fill(""), // "A".."D"
};

// ---------- helpers ----------
function setMsg(html, cls=""){
  msgArea.innerHTML = html ? `<div class="${cls}">${html}</div>` : "";
}
function setSubmitMsg(html, cls=""){
  submitMsg.innerHTML = html ? `<div class="${cls}">${html}</div>` : "";
}
function save(){
  const payload = {
    ...state,
    playerName: playerNameEl.value.trim(),
    characterName: characterNameEl.value.trim(),
  };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
}
function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return;
  try{
    const data = JSON.parse(raw);
    if(data && Array.isArray(data.answers) && data.answers.length===20){
      state = { ...state, ...data };
      playerNameEl.value = state.playerName || "";
      characterNameEl.value = state.characterName || "";
    }
  }catch(e){}
}
function completedCount(){
  return state.answers.filter(x=>x==="A"||x==="B"||x==="C"||x==="D").length;
}
function updateProgress(){
  const done = completedCount();
  progressText.textContent = `${done}/20`;
  progressBar.style.width = `${(done/20)*100}%`;
}

function computeScores(){
  const pts = {};
  FACTIONS.forEach(f=>pts[f.code]=0);

  state.answers.forEach((opt, i) => {
    if(!opt) return;
    const key = `${i+1}-${opt}`;
    const map = SCORE_KEY[key];
    if(!map) return;
    pts[map.p] += 2;
    pts[map.s] += 1;
  });

  const total = Object.values(pts).reduce((a,b)=>a+b,0) || 1;
  const pct = {};
  Object.entries(pts).forEach(([k,v]) => pct[k] = v/total);

  return { pts, pct, total };
}

// Radar chart (simple, no libs)
function drawRadar(pct){
  const W = radarCanvas.width, H = radarCanvas.height;
  radarCtx.clearRect(0,0,W,H);

  const cx = W/2, cy = H/2 + 10;
  const radius = Math.min(W, H)*0.33;

  const labels = FACTIONS.map(f=>f.code);
  const values = FACTIONS.map(f=>pct[f.code] || 0);

  // background
  radarCtx.fillStyle = "rgba(0,0,0,.06)";
  radarCtx.fillRect(0,0,W,H);

  // grid
  const rings = 5;
  radarCtx.strokeStyle = "rgba(31,26,18,.18)";
  radarCtx.lineWidth = 1;

  for(let r=1; r<=rings; r++){
    const rr = radius * (r/rings);
    radarCtx.beginPath();
    for(let i=0; i<labels.length; i++){
      const ang = (Math.PI*2) * (i/labels.length) - Math.PI/2;
      const x = cx + rr*Math.cos(ang);
      const y = cy + rr*Math.sin(ang);
      if(i===0) radarCtx.moveTo(x,y);
      else radarCtx.lineTo(x,y);
    }
    radarCtx.closePath();
    radarCtx.stroke();
  }

  // axes + labels
  radarCtx.fillStyle = "rgba(31,26,18,.90)";
  radarCtx.font = "12px 'Cinzel', serif";
  for(let i=0; i<labels.length; i++){
    const ang = (Math.PI*2) * (i/labels.length) - Math.PI/2;
    radarCtx.strokeStyle = "rgba(31,26,18,.18)";
    radarCtx.beginPath();
    radarCtx.moveTo(cx,cy);
    radarCtx.lineTo(cx + radius*Math.cos(ang), cy + radius*Math.sin(ang));
    radarCtx.stroke();

    const x = cx + (radius+18)*Math.cos(ang);
    const y = cy + (radius+18)*Math.sin(ang);
    const text = labels[i];
    const tw = radarCtx.measureText(text).width;
    radarCtx.fillText(text, x - tw/2, y + 4);
  }

  // polygon
  radarCtx.beginPath();
  for(let i=0; i<labels.length; i++){
    const ang = (Math.PI*2) * (i/labels.length) - Math.PI/2;
    const rr = radius * values[i];
    const x = cx + rr*Math.cos(ang);
    const y = cy + rr*Math.sin(ang);
    if(i===0) radarCtx.moveTo(x,y);
    else radarCtx.lineTo(x,y);
  }
  radarCtx.closePath();
  radarCtx.fillStyle = "rgba(123,31,31,.18)";
  radarCtx.strokeStyle = "rgba(47,107,79,.55)";
  radarCtx.lineWidth = 2;
  radarCtx.fill();
  radarCtx.stroke();

  // title
  radarCtx.fillStyle = "rgba(31,26,18,.90)";
  radarCtx.font = "700 14px 'Cinzel', serif";
  radarCtx.fillText("Afinidad por facci√≥n", 18, 26);
}

function renderScoreTable(pct){
  scoreTableBody.innerHTML = "";
  const sorted = [...FACTIONS].map(f=>({ ...f, v: pct[f.code]||0 }))
    .sort((a,b)=>b.v-a.v);

  sorted.forEach(f=>{
    const tr = document.createElement("tr");

    const td1 = document.createElement("td");
    td1.textContent = f.name;

    const td2 = document.createElement("td");
    td2.textContent = `${Math.round(f.v*100)}%`;

    const td3 = document.createElement("td");
    const bar = document.createElement("div");
    bar.className = "bar";
    const inner = document.createElement("div");
    inner.style.width = `${Math.round(f.v*100)}%`;
    bar.appendChild(inner);
    td3.appendChild(bar);

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    scoreTableBody.appendChild(tr);
  });
}


/* =========================
 * Resultados protegidos (jugador) + bypass DM (?dm=true)
 * ========================= */
function requestPassword(){
  const input = prompt("üîí Resultados protegidos.
Introduce la contrase√±a para ver el resultado final:");
  if (input === null) return false;
  if (input === RESULTS_PASSWORD) return true;
  alert("‚ùå Contrase√±a incorrecta.");
  return false;
}

function showResultsProtected(){
  if(!isDM && !requestPassword()) return;
  showResults();
}

/* =========================
 * Narrativa autom√°tica (SOLO DM)
 * ========================= */
function topFactionsFromPct(pct){
  return [...FACTIONS]
    .map(f => ({ code:f.code, name:f.name, pct: pct[f.code] || 0 }))
    .sort((a,b)=>b.pct-a.pct);
}

function factionFlavor(code){
  const map = {
    HAR:"secreto y prop√≥sito",
    OOG:"juramento y deber",
    EE:"equilibrio y territorio",
    LA:"orden y estabilidad",
    ZH:"red y beneficio",
    BD:"audacia y ventaja",
    GH:"magia y autoridad",
    XG:"control y miedo",
  };
  return map[code] || "influencia";
}

function buildDMNarrative(pct, answers){
  const sorted = topFactionsFromPct(pct);
  const a = sorted[0], b = sorted[1], c = sorted[2];

  // tensi√≥n simple (puedes ampliarla m√°s adelante)
  const tensionPairs = new Set([
    "OOG|ZH","ZH|OOG",
    "LA|XG","XG|LA",
    "HAR|XG","XG|HAR",
    "EE|LA","LA|EE",
  ]);
  const tension = tensionPairs.has(a.code + "|" + b.code);

  const lines = [];
  lines.push(`Tu perfil se inclina hacia ${a.name} (${Math.round(a.pct*100)}%). Huele a ${factionFlavor(a.code)}.`);
  lines.push(`La segunda fuerza es ${b.name} (${Math.round(b.pct*100)}%): eso a√±ade ${factionFlavor(b.code)} a tus decisiones.`);
  lines.push(
    tension
      ? "‚ö†Ô∏è Hay tensi√≥n interesante: tus fines y tus m√©todos no siempre apuntan al mismo sitio. Material perfecto para ganchos."
      : `Tu tercera nota es ${c.name} (${Math.round(c.pct*100)}%): una capa √∫til para complicarte la vida con elegancia.`
  );

  // semilla r√°pida: usa top1
  lines.push("");
  lines.push(`üéØ Semilla: alguien te ofrece un favor ‚Äúlimpio‚Äù que en realidad fortalece a ${a.name}. Si aceptas, te ata; si rechazas, te vigilan.`);

  // mini-resumen de elecciones (r√°pido)
  if(answers && answers.length){
    lines.push("");
    lines.push(`üìå Respuestas: ${answers.map((x,i)=> (i+1)+x).join(" ¬∑ ")}`);
  }

  return lines.join("\n");
}

function renderDMOnly(pct){
  const dmBox = document.getElementById("dmOnly");
  const dmText = document.getElementById("dmNarrative");
  const copyBtn = document.getElementById("copyProfileBtn");
  if(!dmBox || !dmText || !copyBtn) return;

  if(!isDM){
    dmBox.style.display = "none";
    return;
  }

  dmBox.style.display = "";
  const narrative = buildDMNarrative(pct, state.answers);

  dmText.textContent = narrative;

  copyBtn.onclick = async () => {
    const sorted = topFactionsFromPct(pct);
    const jugador = (playerName.value || "").trim();
    const pj = (characterName.value || "").trim();
    const top3 = sorted.slice(0,3).map(x => `${x.name} (${Math.round(x.pct*100)}%)`).join(" ¬∑ ");

    const clip =
`Perfil Waterdeep (DM)
Jugador: ${jugador}
PJ: ${pj}
Top: ${top3}

${narrative}`;

    try{
      await navigator.clipboard.writeText(clip);
      alert("‚úÖ Perfil copiado al portapapeles.");
    }catch(e){
      alert("‚ùå No se pudo copiar (permiso del navegador).");
    }
  };
}


function showResults(){
  const { pct } = computeScores();
  drawRadar(pct);
  renderScoreTable(pct);
  renderDMOnly(pct);
  questionCard.style.display = "none";
  resultCard.style.display = "";
}

function showQuestion(){
  questionCard.style.display = "";
  resultCard.style.display = "none";
}

function canSubmit(){
  return completedCount() === 20 &&
    playerNameEl.value.trim().length > 0 &&
    characterNameEl.value.trim().length > 0;
}

function render(){
  updateProgress();

  toggleResultsBtn.textContent = `üëÅÔ∏è Mostrar resultado al final: ${state.showResults ? "S√≠" : "No"}`;

  // update theme button label
  if(themeBtn){
    const current = document.documentElement.dataset.theme || "night";
    themeBtn.textContent = current === "parchment" ? "üïØÔ∏è Pergamino" : "üåô Noche";
  }

  const q = QUESTIONS[state.idx];
  qTitle.textContent = q.title;
  qContext.textContent = q.context;
  qPrompt.textContent = q.prompt;
  qMeta.textContent = "";
  qIndexPill.textContent = String(state.idx+1);

  optionsEl.innerHTML = "";
  ["A","B","C","D"].forEach(letter=>{
    const div = document.createElement("div");
    div.className = "opt" + (state.answers[state.idx]===letter ? " selected" : "");
    div.onclick = () => {
      state.answers[state.idx] = letter;
      setMsg("", "");
      save();
      render();
    };

    const badge = document.createElement("div");
    badge.className = "letter";
    badge.textContent = letter;

    const text = document.createElement("div");
    text.className = "text";
    text.textContent = q.options[letter];

    div.appendChild(badge);
    div.appendChild(text);
    optionsEl.appendChild(div);
  });

  prevBtn.disabled = state.idx===0;
  nextBtn.textContent = state.idx===19 ? "Finalizar ‚Üí" : "Siguiente ‚Üí";
  submitBtn.disabled = !canSubmit();
}

// ---------- Tema ----------
function setTheme(theme){
  document.documentElement.dataset.theme = theme;
  localStorage.setItem(THEME_KEY, theme);
  if(themeBtn){
    themeBtn.textContent = theme === "parchment" ? "üïØÔ∏è Pergamino" : "üåô Noche";
  }
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  const theme = saved || "night";
  setTheme(theme);
}
if(themeBtn){
  themeBtn.addEventListener("click", () => {
    const current = document.documentElement.dataset.theme || "night";
    const next = current === "night" ? "parchment" : "night";
    setTheme(next);
  });
}

// ---------- Env√≠o ----------
async function submit(){
  setSubmitMsg("", "");
  if(!canSubmit()){
    setSubmitMsg("Falta completar todo y/o indicar nombre del jugador y del personaje.", "error");
    return;
  }
  if(!FORM_ENDPOINT.includes("formspree.io")){
    setSubmitMsg("Falta configurar FORM_ENDPOINT con tu URL de Formspree.", "error");
    return;
  }

  submitBtn.disabled = true;
  const { pts, pct, total } = computeScores();

  const payload = {
    playerName: playerNameEl.value.trim(),
    characterName: characterNameEl.value.trim(),
    timestamp: new Date().toISOString(),
    answers: state.answers.map((x,i)=>({ scene:i+1, answer:x })),
    scores_points: pts,
    scores_percent: pct,
    total_points: total,
    top3: [...FACTIONS].map(f=>({code:f.code, name:f.name, pct:pct[f.code]||0}))
      .sort((a,b)=>b.pct-a.pct).slice(0,3),
    theme: document.documentElement.dataset.theme || "night",
    userAgent: navigator.userAgent
  };

  try{
    const res = await fetch(FORM_ENDPOINT, {
      method:"POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(payload)
    });

    if(res.ok){
      if(!isDM){
        // Confirmaci√≥n silenciosa (sin mostrar % ni facciones)
        setSubmitMsg("üïØÔ∏è Tu perfil ha sido registrado en Waterdeep.", "ok");
        // Oculta resultados al jugador (si estaban visibles)
        const radarEl = document.getElementById("radar");
        const tableEl = document.getElementById("scoreTable");
        if(radarEl) radarEl.style.display = "none";
        if(tableEl) tableEl.style.display = "none";
        const dmOnlyEl = document.getElementById("dmOnly");
        if(dmOnlyEl) dmOnlyEl.style.display = "none";
      }else{
        setSubmitMsg("‚úÖ Enviado (DM).", "ok");
      }
    }else{
      const t = await res.text();
      setSubmitMsg("‚ùå Error al enviar. Revisa tu Formspree y el endpoint. Detalle: " + t.slice(0,180), "error");
      submitBtn.disabled = false;
    }
  }catch(e){
    setSubmitMsg("‚ùå No se pudo enviar (sin conexi√≥n o endpoint incorrecto).", "error");
    submitBtn.disabled = false;
  }
}

// ---------- Events ----------
playerNameEl.addEventListener("input", save);
characterNameEl.addEventListener("input", save);

toggleResultsBtn.addEventListener("click", () => {
  state.showResults = !state.showResults;
  save();
  render();
});

resetBtn.addEventListener("click", () => {
  if(!confirm("¬øSeguro que quieres reiniciar el test en este dispositivo?")) return;
  localStorage.removeItem(LS_KEY);
  state = {
    idx: 0,
    playerName: "",
    characterName: "",
    showResults: true,
    answers: Array(20).fill(""),
  };
  playerNameEl.value = "";
  characterNameEl.value = "";
  setSubmitMsg("");
  render();
  save();
});

prevBtn.addEventListener("click", () => {
  if(state.idx>0){ state.idx--; save(); render(); }
});

nextBtn.addEventListener("click", () => {
  if(state.idx<19){
    state.idx++;
    save();
    render();
    return;
  }
  // final
  if(completedCount() < 20){
    setMsg("Te faltan escenas por responder. Puedes volver y completar antes de enviar.", "error");
    if(state.showResults){
      showResultsProtected();
    }
    return;
  }
  showResultsProtected();
});

backToReviewBtn.addEventListener("click", () => {
  showQuestion();
});

submitBtn.addEventListener("click", submit);

// ---------- init ----------
load();
initTheme();
render();
</script>
</body>
</html>
